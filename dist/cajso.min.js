define(function(require,exports,module){

"use strict";function xhrUtil(e,t,n,o,r){return new Promise(function(i,u){var a=void 0;try{a=new XMLHttpRequest}catch(e){try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){console&&debug.info("xhrUtil: XMLHttpRequest not supported"),u(INTERNAL_ERROR)}}a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE&&a.status>=200&&a.status<300){debug.info("Success. Status:"+a.status);var e={};e.httpStatus=a.status,204!=a.status?e.data=JSON.parse(a.responseText):e.data="",i(e)}else{var t=void 0;if(a.readyState===XMLHttpRequest.DONE){a.status>=500&&a.status<600?t=server_errCode:400===a.status?t=bad_request_errCode:401===a.status?(localStorage.removeItem("t-"+o),t=invalid_cred_errCode):t=404===a.status?api_not_found_errCode:network_errCode;var n={};n.httpStatus=a.status,a.responseText?n.errMsg=JSON.parse(a.responseText):n.errMsg={error:"error"},debug.info("Failure. Status:"+a.status),n.errorCode=t,u(n)}}},a.open(t?t.toUpperCase():"GET",e,!0);for(var s=0;s<n.length;s++)a.setRequestHeader(n[s].key,n[s].value);"POST"===t||"PUT"===t||"PATCH"===t?a.send(r):a.send()})}function bytesToHex(e){for(var t=[],n=0;n<e.length;n++)t.push((e[n]>>>4).toString(16)),t.push((15&e[n]).toString(16));return t.join("")}function hexToBytes(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t}function ab2str(e){return String.fromCharCode.apply(null,e)}function str2ab(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint8Array(t),o=0,r=e.length;o<r;o++)n[o]=e.charCodeAt(o);return n}function pQString(e){for(var t=/\+/g,n={},o=e.substr(0).split("&"),r=0;r<o.length;r++){var i=o[r].split("=");n[decodeURIComponent(i[0])]=decodeURIComponent(i[1]||"").replace(t," ")}return n}function do_configuration(e){var t=Object.keys(e)[0];config=e,getTokenFromURLFragment(t)}function doAuthorize(e,t){var n=void 0,o=void 0,r=void 0,i=void 0,u="";n=t.state,t.idTokenRequired&&t.idTokenRequired===!0?(o={response_type:"token id_token"},o.nonce=getNonce()):o={response_type:"token"},o.state=n,o.redirect_uri=t.redirect_uri,o.client_id=t.client_id,o.scope=t.scope.join(" ");var a=0;for(i in o)u+=(0===a++?"?":"&")+encodeURIComponent(i)+"="+encodeURIComponent(o[i]);r=""+t.auth_url+u,debug.info("Authorization url is",r),window.location.hash&&(o.restoreHash=window.location.hash),o.profileId=e,localStorage.setItem("s-"+n,JSON.stringify(o)),window.location=r}function performHttpOp(e,t,n,o,r,u){function a(a){var s=a.replace(/\0[\s\S]*$/g,""),c="Bearer "+encodeURIComponent(new String(s));n.push({key:"Authorization",value:c});var d="";if(o){var f=0;for(i in o)d+=(0===f++?"?":"&")+encodeURIComponent(i)+"="+encodeURIComponent(o[i])}return t+=d,xhrUtil(t,e,n,r,u)}return new Promise(function(e,t){var n=getToken(r);n?decryptToken(n.access_token).then(function(n){a(n).then(function(t){return e(t)},function(e){return t(e)})},function(e){debug.info(e),t(CRYPTO_ERROR)}):(debug.info("Token Error"),t(TOKEN_ERROR))})}function getStateFromProfileId(e){var t=JSON.parse(localStorage.getItem("t-"+e));if(t){var n=t[0];return n.state}}function getNonce(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function encryptToken(e,t){return new Promise(function(n,o){encrypt(e).then(function(e){t.encToken=e,saveEncToken(t),n()},function(e){debug.info(e),o(e)})})}function decryptToken(e){return new Promise(function(t,n){decrypt(e).then(function(e){t(e)},function(e){debug.info(e),n(e)})})}function getTokenFromURLFragment(){return new Promise(function(e,t){var n=void 0,o=void 0,r=void 0,i=Math.round((new Date).getTime()/1e3),u=window.location.hash;if(u.length<2&&e(),u.indexOf("access_token")===-1&&e(),u=u.substring(1),n=pQString(u),n.expiresAt=i+parseInt(n.expires_in,10),window.location.hash="",r=n.state,r?(debug.info("Got state ID as:"+r),o=JSON.parse(localStorage.getItem("s-"+r))):(debug.info("Could not retrieve state from URL fragment"),t("Could not retrieve state from URL fragment")),o){debug.info("Retrieved state for profileId :"+o.profileId),localStorage.removeItem("s-"+r);var a={profileId:o.profileId,token:n};encryptToken(n.access_token,a).then(function(){e(o.state)},function(e){t(e)})}else t("Could not retrieve state from localStorage")})}function saveEncToken(e){var t=e.token;t.access_token=e.encToken;var n=JSON.parse(localStorage.getItem("t-"+e.profileId));n||(n=[]),n=checkValidTokens(n),n.push(t),localStorage.setItem("t-"+e.profileId,JSON.stringify(n))}function retrieveToken(e,t){var n=void 0;return n=getToken(e,t.scope),!!n||(doAuthorize(e,t),!1)}function getToken(e,t){var n=JSON.parse(localStorage.getItem("t-"+e));return n?(n=checkValidTokens(n,t),n.length>0?n[0]:void 0):void 0}function checkValidTokens(e,t){var n=void 0,o=void 0,r=[],i=Math.round((new Date).getTime()/1e3),u=void 0;for(t||(t=[]),n=0;n<e.length;n++){u=!0;var a=void 0;for(a=e[n],a.expiresAt&&a.expiresAt<i+1&&(u=!1),o=0;o<t.length;o++)hasScope(a,t[o])||(u=!1);u&&r.push(a)}return r}function hasScope(e,t){if(!e.scope)return!1;var n=e.scope.split(" "),o=void 0;for(o=0;o<n.length;o++)if(n[o]===t)return!0;return!1}function getKey(){var e=db.transaction([TABLE_1],IDBTransaction.READ_WRITE),t=e.objectStore(TABLE_1),n=t.get(STOREKEY);n.onerror=function(e){debug.info("Unable to retrieve data from database!")},n.onsuccess=function(e){if(aes128Key=n.result){debug.info("Got key. Listing properties:");for(var t in aes128Key)debug.info(aes128Key[t]);cryptoInitCallBack()}else debug.info("Key could not be found in your database!"),generateEncKey()}}function storeKey(e){var t=db.transaction([TABLE_1],IDBTransaction.READ_WRITE);t.oncomplete=function(e){debug.info("txn success")},t.onabort=function(e){debug.info("txn failed")};var n=t.objectStore(TABLE_1),o=n.put(e,STOREKEY);o.onerror=function(){debug.info("store failed")},o.onsuccess=function(){debug.info("key stored successfully")}}function dbOnUpgradeNeeded(e){if(debug.info("running onupgradeneeded"),debug.info("dbOnUpgradeNeeded"),db=e.target.result,!db.objectStoreNames.contains(TABLE_1)){debug.info("Create the TokenTable objectstore");db.createObjectStore(TABLE_1)}}function dbError(e){debug.info("Unable to open:"+DB_NAME)}function dbSuccess(e){debug.info("dbSuccess"),db=e.target.result,getKey()}function do_clear(e){function t(t){var n=[];n.push({key:"Content-Type",value:"application/x-www-form-urlencoded"});var o=e.revokeTokenUrl,r={};r.token=t.replace(/\0[\s\S]*$/g,""),r.token_type_hint="access_token",r.client_id=e.client_id;var i="",u=void 0,a=0;for(u in r)i+=(0===a++?"":"&")+u+"="+r[u];return xhrUtil(o,"POST",n,e.profileId,i)}return new Promise(function(n,o){var r=getToken(e.profileId);localStorage.removeItem("t-"+e.profileId),r&&decryptToken(r.access_token).then(function(e){t(e).then(function(e,t){n(e)},function(e){return o(e)})},function(e){debug.info(e),o(CRYPTO_ERROR)})})}function cryptoInit(){return new Promise(function(e,t){window.crypto&&!window.crypto.subtle&&window.crypto.webkitSubtle&&(window.crypto.subtle=window.crypto.webkitSubtle,crypto.subtle=window.crypto.webkitSubtle),dbInit().then(function(n){return getKey(n).then(function(){e("CryptoInit successfully")},function(e){t(e)})},function(e){t(e)})})}function dbOnUpgradeNeeded(e){debug.info("running onupgradeneeded"),debug.info("dbOnUpgradeNeeded");var t=e.target.result;if(!t.objectStoreNames.contains(TABLE_1)){debug.info("Create the TokenTable objectstore");t.createObjectStore(TABLE_1)}}function dbInit(){return new Promise(function(e,t){debug.info("Db name is",DB_NAME),window.indexedDB||(debug.info("indexeddb is not supported on this browser"),t("indexeddb is not supported on this browser")),IDBTransaction.READ_WRITE||(IDBTransaction.READ_WRITE="readwrite");var n=window.indexedDB.open(DB_NAME,1);n.onerror=function(){debug.info("unable to open DB"),t("unable to open DB")},n.onsuccess=function(t){e(t.target.result)},n.onupgradeneeded=dbOnUpgradeNeeded})}function generateEncKey(e){return new Promise(function(t,n){window.crypto.subtle?(keyop=window.crypto.subtle.generateKey(aesAlgorithmKeyGen,!1,["encrypt","decrypt"]),keyop.then(function(n){aes128Key=n,storeKey(e,aes128Key),t("AES key generated successfully")},function(){n("Unable to generate key")})):n("Web Cryptography API not supported - please update your browser")})}function getKey(e){return new Promise(function(t,n){var o=e.transaction([TABLE_1],IDBTransaction.READ_WRITE),r=o.objectStore(TABLE_1),i=r.get(STOREKEY);i.onerror=function(e){debug.info("Unable to retrieve data from database!"),n("Unable to retrieve data from database!")},i.onsuccess=function(o){if(aes128Key=i.result){debug.info("Got key. Listing properties:");for(var r in aes128Key)debug.info(aes128Key[r]);t("Got key")}else debug.info("Generating key..."),generateEncKey(e).then(function(e){t("Got key")},function(e){n(e)})}})}function storeKey(e,t){var n=e.transaction([TABLE_1],IDBTransaction.READ_WRITE);n.oncomplete=function(e){debug.info("txn success")},n.onabort=function(e){debug.info("txn failed")};var o=n.objectStore(TABLE_1),r=o.put(t,STOREKEY);r.onerror=function(){debug.info("store failed")},r.onsuccess=function(){debug.info("key stored successfully")}}function encrypt(e){return new Promise(function(t,n){var o=window.crypto.getRandomValues(new Uint8Array(16)),r={name:"AES-CBC",iv:o},i=window.crypto.subtle.encrypt(r,aes128Key,str2ab(e));i.then(function(e){cipherTextArrayBuffer=new Uint8Array(e),localStorage.setItem("salt",bytesToHex(o)),t(bytesToHex(cipherTextArrayBuffer))},function(){console.error.bind(console,"Encryption failed using Crypto API."),n("Encryption failed")})})}function decrypt(e){return new Promise(function(t,n){var o,r=new Uint8Array(hexToBytes(localStorage.getItem("salt"))),i={name:"AES-CBC",iv:r},u=window.crypto.subtle.decrypt(i,aes128Key,new Uint8Array(hexToBytes(e)));u.then(function(e){o=e;var n=new Uint8Array(e);debug.info("Got decrypted text"),t(ab2str(n))},function(){console.error.bind(console,"Decryption failed using Crypto API."),n("Decryption failed using Crypto API.")})})}var SUCCESS=0,ERROR=-1,TOKEN_ERROR={httpStatus:0,errorCode:-1001,errMsg:"Token Error"},INTERNAL_ERROR={httpStatus:0,errorCode:-1002,errMsg:"xhrUtil: XMLHttpRequest not supported"},CRYPTO_ERROR={httpStatus:0,errorCode:-1003,errMsg:"Crypto Error"},network_errCode=-1004,server_errCode=-1005,invalid_cred_errCode=-1006,api_not_found_errCode=-1007,bad_request_errCode=-1008,NETWORK_ERROR=void 0,SERVER_ERROR=void 0,INVALID_CREDENTIALS=void 0,API_NOT_FOUND=void 0,BAD_REQUEST=void 0,Debugger=function(e){var t={};if(!window.console)return function(){};if(e)for(var n in console)"function"==typeof console[n]&&(t[n]=console[n].bind(window.console));else for(var o in console)"function"==typeof console[o]&&(t[o]=function(){});return t},_jsoclient_instance_=null,DB_NAME="CAJSOC",TABLE_1="TokenTable",STOREKEY="enckey",db=void 0,indexedDB=null,aes128Key=null,keyop=void 0,cipherTextArrayBuffer=void 0,crypto=void 0,doInitCallBack=void 0,cryptoInitCallback=void 0,aesAlgorithmKeyGen={name:"aes-cbc",length:128},decryptedToken=void 0,isDebug=!1,configuration={},server={},debug=Debugger(isDebug),cajso=function(){this.init=function(){return new Promise(function(e,t){cryptoInit().then(function(){getTokenFromURLFragment().then(function(t){e(t)},function(e){t(e)})},function(e){t(e)})})},this.authorize=function(e,t){return retrieveToken(e,t)},this.get=function(e,t,n,o){return performHttpOp("GET",e,t,n,o)},this.post=function(e,t,n,o,r){return performHttpOp("POST",e,t,n,o,r)},this.put=function(e,t,n,o,r){return performHttpOp("PUT",e,t,n,o,r)},this.patch=function(e,t,n,o,r){return performHttpOp("PATCH",e,t,n,o,r)},this.delete=function(e,t,n,o){return performHttpOp("DELETE",e,t,n,o)},this.isTokenAvailable=function(e){var t=getToken(e);return!!t},this.revokeToken=function(e){return do_clear(e)},this.getState=function(e){return getStateFromProfileId(e)},_jsoclient_instance_=this};
return cajso;

});
